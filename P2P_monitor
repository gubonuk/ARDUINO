ëª¨ë‹ˆí„°ì™„ì„±ì½”ë“œ
#include <WiFi.h>
#include <esp_wifi.h>
#include <esp_now.h>

#define MAX_DEVICES 1
#define RANDOM_INTERVAL 3000  // 3ì´ˆë§ˆë‹¤ ì‹¤í–‰

// ğŸ“Œ 1ë²ˆ Deviceì˜ MAC ì£¼ì†Œ ì €ì¥
uint8_t deviceMacAddressList[MAX_DEVICES][6] = {
    {0x24, 0x6F, 0x28, 0xAB, 0xCD, 0xEF}  // 1ë²ˆ Device
};

uint8_t deviceStates[MAX_DEVICES] = {0};  // ì´ˆê¸° ìƒíƒœ (OFF)

// ğŸ“Œ Peer ë“±ë¡ ì—¬ë¶€ (í•œ ë²ˆë§Œ ë“±ë¡í•˜ë©´ ë¨)
bool peerRegistered[MAX_DEVICES] = {false};

//------------------------------------------------------------------------------
// ğŸ“Œ (1) Peer ë“±ë¡ í•¨ìˆ˜ (Monitorê°€ Deviceì—ê²Œ ì†¡ì‹ í•˜ë ¤ë©´ í•„ìš”)
//------------------------------------------------------------------------------
void RegisterPeer(int deviceIndex) {
    esp_now_peer_info_t peerInfo = {};
    memcpy(peerInfo.peer_addr, deviceMacAddressList[deviceIndex], 6);
    peerInfo.channel = 0;
    peerInfo.encrypt = false;

    if (esp_now_add_peer(&peerInfo) == ESP_OK) {
        Serial.println("Device " + String(deviceIndex + 1) + " í”¼ì–´ ë“±ë¡ ì™„ë£Œ");
        peerRegistered[deviceIndex] = true;
    } else {
        Serial.println("Device " + String(deviceIndex + 1) + " í”¼ì–´ ë“±ë¡ ì‹¤íŒ¨!");
    }
}

//------------------------------------------------------------------------------
// ğŸ“Œ (2) OnDataRecv: Deviceì—ì„œ OFF(0) ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í•˜ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
//------------------------------------------------------------------------------
void OnDataRecv(const esp_now_recv_info_t *recvInfo, const uint8_t *data, int len) {
    for (int i = 0; i < MAX_DEVICES; i++) {
        if (memcmp(deviceMacAddressList[i], recvInfo->src_addr, 6) == 0) {
            if (*data == 0) {
                deviceStates[i] = 0;  // OFF ìƒíƒœ ì—…ë°ì´íŠ¸
                Serial.println("Device " + String(i + 1) + " â†’ OFF");
            }
            break;
        }
    }
}

//------------------------------------------------------------------------------
// ğŸ“Œ (3) 3ì´ˆë§ˆë‹¤ OFFëœ ê¸°ê¸° ì¤‘ í•˜ë‚˜ë¥¼ ëœë¤ ì„ íƒí•˜ì—¬ ON ì‹ í˜¸ ì „ì†¡
//------------------------------------------------------------------------------
void SelectRandomDeviceAndTurnOn() {
    int offDevices[MAX_DEVICES];
    int offCount = 0;

    // OFF ìƒíƒœì¸ ê¸°ê¸° ì°¾ê¸°
    for (int i = 0; i < MAX_DEVICES; i++) {
        if (deviceStates[i] == 0) {
            offDevices[offCount++] = i;
        }
    }

    // ëœë¤ ì„ íƒ í›„ ON ì‹ í˜¸ ì „ì†¡
    if (offCount > 0) {
        int randomIndex = random(offCount);
        int deviceIndex = offDevices[randomIndex];

        // í”¼ì–´ ë“±ë¡ì´ ì•ˆ ëœ ê²½ìš° ë¨¼ì € ë“±ë¡
        if (!peerRegistered[deviceIndex]) {
            RegisterPeer(deviceIndex);
        }

        uint8_t msg = 1;
        esp_now_send(deviceMacAddressList[deviceIndex], &msg, sizeof(msg));  // ON ì‹ í˜¸ ì „ì†¡
        deviceStates[deviceIndex] = 1;  // ìƒíƒœ ONìœ¼ë¡œ ê°±ì‹ 
        Serial.println("Device " + String(deviceIndex + 1) + " â†’ ON");
    }
}

//------------------------------------------------------------------------------
// ğŸ“Œ (4) setup(): ESP-NOW ì´ˆê¸°í™” ë° í”¼ì–´ ë“±ë¡
//------------------------------------------------------------------------------
void setup() {
    Serial.begin(115200);
    WiFi.mode(WIFI_STA);  // ESP-NOW ì‚¬ìš© ì‹œ STA ëª¨ë“œ í•„ìš”

    // ğŸ“Œ ESP-NOW ì´ˆê¸°í™”
    if (esp_now_init() != ESP_OK) {
        Serial.println("ESP-NOW ì´ˆê¸°í™” ì‹¤íŒ¨!");
        return;
    }

    // ğŸ“Œ ë°ì´í„° ìˆ˜ì‹  ì½œë°± ë“±ë¡
    esp_now_register_recv_cb(OnDataRecv);

    // ğŸ“Œ 1ë²ˆ Device í”¼ì–´ ë“±ë¡
    for (int i = 0; i < MAX_DEVICES; i++) {
        RegisterPeer(i);
    }

    randomSeed(analogRead(0));
}

//------------------------------------------------------------------------------
// ğŸ“Œ (5) loop(): 3ì´ˆë§ˆë‹¤ OFFëœ ê¸°ê¸° ì¤‘ í•˜ë‚˜ë¥¼ ëœë¤ ì„ íƒí•˜ì—¬ ON ì‹ í˜¸ ì „ì†¡
//------------------------------------------------------------------------------
void loop() {
    static unsigned long lastUpdateTime = 0;
    unsigned long currentMillis = millis();

    if (currentMillis - lastUpdateTime >= RANDOM_INTERVAL) {
        lastUpdateTime = currentMillis;
        SelectRandomDeviceAndTurnOn();
    }
}
