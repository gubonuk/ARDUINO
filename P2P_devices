#include <WiFi.h>
#include <esp_wifi.h>
#include <esp_now.h>

#define LED_PIN 2       // LED ì—°ê²° í•€
#define BUTTON_PIN 4    // ë²„íŠ¼ í•€ (í’€ë‹¤ìš´ ë°©ì‹: ëˆŒë¦¼ ì‹œ HIGH)

// ğŸ“Œ 1ë²ˆ Deviceì˜ STA MAC ì£¼ì†Œ ì„¤ì •
uint8_t myMacAddress[6] = {0x24, 0x6F, 0x28, 0x12, 0x34, 0x56};

// ğŸ“Œ Monitorì˜ MAC ì£¼ì†Œ ì €ì¥ ê³µê°„
uint8_t monitorMacAddress[6];  

// ğŸ“Œ LED ìƒíƒœ (0=OFF, 1=ON)
uint8_t ledState = 0;

// ğŸ“Œ Monitorì™€ì˜ í”¼ì–´ ë“±ë¡ ì—¬ë¶€ (í•œ ë²ˆë§Œ ë“±ë¡)
bool peerRegistered = false;

//------------------------------------------------------------------------------
// ğŸ“Œ (1) OnDataRecv: Monitorì—ì„œ ë°ì´í„° ìˆ˜ì‹  ì‹œ í˜¸ì¶œ
//     - Monitor MAC ì£¼ì†Œ ì €ì¥
//     - ìˆ˜ì‹  ê°’ì´ 1ì´ë©´ LED ì¼œê¸°
//     - Peer ë“±ë¡ (Monitor MACì„ í†µí•´ Device â†’ Monitor ì†¡ì‹  ê°€ëŠ¥)
//------------------------------------------------------------------------------
void OnDataRecv(const esp_now_recv_info_t *recvInfo, const uint8_t *data, int len) {
    // Monitor MAC ì£¼ì†Œ ì €ì¥
    memcpy(monitorMacAddress, recvInfo->src_addr, 6);

    // ìˆ˜ì‹  ë°ì´í„° í™•ì¸ (1ì´ë©´ LED ON)
    if (*data == 1 && ledState == 0) {
        digitalWrite(LED_PIN, HIGH);
        ledState = 1;
    }

    // ğŸ“Œ Monitor MACì´ ìƒˆë¡œ ë“¤ì–´ì™”ì„ ë•Œ Peer ë“±ë¡ (í•œ ë²ˆë§Œ ë“±ë¡)
    if (!peerRegistered) {
        esp_now_peer_info_t peerInfo = {};
        memcpy(peerInfo.peer_addr, monitorMacAddress, 6);
        peerInfo.channel = 0;     
        peerInfo.encrypt = false; 

        if (esp_now_add_peer(&peerInfo) == ESP_OK) {
            Serial.println("Monitor í”¼ì–´ ë“±ë¡ ì™„ë£Œ");
            peerRegistered = true;
        } else {
            Serial.println("Monitor í”¼ì–´ ë“±ë¡ ì‹¤íŒ¨!");
        }
    }
}

//------------------------------------------------------------------------------
// ğŸ“Œ (2) setup(): STA MAC ì„¤ì •, ESP-NOW ì´ˆê¸°í™”, ì½œë°± ë“±ë¡, GPIO ì´ˆê¸°í™”
//------------------------------------------------------------------------------
void setup() {
    Serial.begin(115200);

    // ğŸ“Œ (2-1) STA ëª¨ë“œ ì„¤ì • ë° Wi-Fi ì‹œì‘ í›„ MAC ì£¼ì†Œ ë³€ê²½
    WiFi.mode(WIFI_STA);
    esp_wifi_start();  // Wi-Fi ì¸í„°í˜ì´ìŠ¤ í™œì„±í™”
    
    // ğŸ“Œ (2-2) STA MAC ì£¼ì†Œ ë³€ê²½
    esp_err_t err = esp_wifi_set_mac(WIFI_IF_STA, myMacAddress);
    if (err == ESP_OK) {
        Serial.print("STA MAC ì£¼ì†Œ ì„¤ì • ì„±ê³µ: ");
    } else {
        Serial.printf("STA MAC ì£¼ì†Œ ì„¤ì • ì‹¤íŒ¨ (err=0x%X)\n", err);
    }

    // ğŸ“Œ (2-3) ì„¤ì •ëœ MAC ì£¼ì†Œ í™•ì¸
    uint8_t checkMac[6];
    esp_wifi_get_mac(WIFI_IF_STA, checkMac);
    Serial.printf("STA MAC: %02X:%02X:%02X:%02X:%02X:%02X\n",
                  checkMac[0], checkMac[1], checkMac[2],
                  checkMac[3], checkMac[4], checkMac[5]);

    // ğŸ“Œ (2-4) ESP-NOW ì´ˆê¸°í™”
    if (esp_now_init() != ESP_OK) {
        Serial.println("ESP-NOW ì´ˆê¸°í™” ì‹¤íŒ¨!");
        return;
    }

    // ğŸ“Œ (2-5) ë°ì´í„° ìˆ˜ì‹  ì½œë°± ë“±ë¡ (Monitorì—ì„œ ë°ì´í„° ìˆ˜ì‹  ì‹œ OnDataRecv() í˜¸ì¶œ)
    esp_now_register_recv_cb(OnDataRecv);

    // ğŸ“Œ (2-6) GPIO ì´ˆê¸°í™”
    pinMode(LED_PIN, OUTPUT);
    pinMode(BUTTON_PIN, INPUT);  // í’€ë‹¤ìš´: ëˆŒë¦¬ë©´ HIGH
    digitalWrite(LED_PIN, LOW);  // ì´ˆê¸° LED ìƒíƒœ OFF
}

//------------------------------------------------------------------------------
// ğŸ“Œ (3) loop(): ë²„íŠ¼ì´ ëˆŒë¦¬ë©´ OFF(0) ì‹ í˜¸ë¥¼ Monitorì— ì „ì†¡
//------------------------------------------------------------------------------
void loop() {
    // ë²„íŠ¼ì´ HIGH ì´ê³ , í˜„ì¬ LEDê°€ ON(1) ìƒíƒœë¼ë©´ -> OFF ì „ì†¡
    if (digitalRead(BUTTON_PIN) == HIGH && ledState == 1) {
        // ğŸ“Œ Monitorì—ê²Œ OFF(0) ì‹ í˜¸ ì „ì†¡
        uint8_t msg = 0;
        esp_now_send(monitorMacAddress, &msg, sizeof(msg));

        // ğŸ“Œ LED ë„ê¸°
        digitalWrite(LED_PIN, LOW);
        ledState = 0;
    }
}
